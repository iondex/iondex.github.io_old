<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"iondex.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Iondex&#39;s Blog">
<meta property="og:url" content="http://iondex.github.io/index.html">
<meta property="og:site_name" content="Iondex&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="iondex">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://iondex.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Iondex's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Iondex's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://iondex.github.io/2020/10/04/android-mediaextractor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="iondex">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Iondex's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/04/android-mediaextractor/" class="post-title-link" itemprop="url">Android 7.0 MediaExtractor 分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-10-04 20:51:28 / Modified: 21:03:40" itemprop="dateCreated datePublished" datetime="2020-10-04T20:51:28+08:00">2020-10-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>版本：Android Nougat 7.1.1_r6</p>
<p>源码：<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/services/mediaextractor">AndroidXRef</a></p>
<h2 id="启动分析"><a href="#启动分析" class="headerlink" title="启动分析"></a>启动分析</h2><p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/services/mediaextractor/main_extractorservice.cpp">main_extractorservice.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __unused, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 限制访问的物理内存数量为20%。</span></span><br><span class="line">    limitProcessMemory(</span><br><span class="line">        <span class="string">&quot;ro.media.maxmem&quot;</span>, <span class="comment">/* property that defines limit */</span></span><br><span class="line">        SIZE_MAX, <span class="comment">/* upper limit in bytes */</span></span><br><span class="line">        <span class="number">20</span> <span class="comment">/* upper limit as percentage of physical RAM */</span>);</span><br><span class="line"></span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line">    <span class="comment">// 设置进程的MiniJail</span></span><br><span class="line">    MiniJail();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化ICU4C</span></span><br><span class="line">    InitializeIcuOrDie();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置自身的进程名为 media.extractor</span></span><br><span class="line">    <span class="built_in">strcpy</span>(argv[<span class="number">0</span>], <span class="string">&quot;media.extractor&quot;</span>);</span><br><span class="line">    <span class="comment">// 初始化ProcessState，获取ServiceManager</span></span><br><span class="line">    <span class="function">sp&lt;ProcessState&gt; <span class="title">proc</span><span class="params">(ProcessState::self())</span></span>;</span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建MediaExtractorService实例</span></span><br><span class="line">    <span class="comment">// 所以启动的Binder线程是MediaExtractorService</span></span><br><span class="line">    MediaExtractorService::instantiate();</span><br><span class="line">    <span class="comment">// 开启Binder线程</span></span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MediaExtractorService实现分析"><a href="#MediaExtractorService实现分析" class="headerlink" title="MediaExtractorService实现分析"></a>MediaExtractorService实现分析</h2><p>MediaExtractorService继承了BnMediaExtractor和一个特殊的类BinderService。其本质是一个辅助类，包括了一些辅助功能。实现如下：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/include/binder/BinderService.h">BinderService.h</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> SERVICE&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinderService</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 向ServiceManager注册这个服务。getServiceName是需要接口实现的方法。</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">status_t</span> <span class="title">publish</span><span class="params">(<span class="keyword">bool</span> allowIsolated = <span class="literal">false</span>)</span> </span>&#123;</span><br><span class="line">        <span class="function">sp&lt;IServiceManager&gt; <span class="title">sm</span><span class="params">(defaultServiceManager())</span></span>;</span><br><span class="line">        <span class="keyword">return</span> sm-&gt;addService(</span><br><span class="line">                String16(SERVICE::getServiceName()),</span><br><span class="line">                <span class="keyword">new</span> SERVICE(), allowIsolated);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原本常见的instantiate方法成为包装方法</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">instantiate</span><span class="params">()</span> </span>&#123; publish(); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/services/mediaextractor/MediaExtractorService.h">MediaExtractorService.h</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MediaExtractorService</span> :</span> <span class="keyword">public</span> BinderService&lt;MediaExtractorService&gt;, <span class="keyword">public</span> BnMediaExtractorService</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderService</span>&lt;MediaExtractorService&gt;;</span>    <span class="comment">// for MediaExtractorService()</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 为BinderService实现的getServiceName方法</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>*  <span class="title">getServiceName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">&quot;media.extractor&quot;</span>; &#125;</span><br><span class="line">    <span class="comment">// makeExtractor包装方法</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> sp&lt;IMediaExtractor&gt; <span class="title">makeExtractor</span><span class="params">(<span class="keyword">const</span> sp&lt;IDataSource&gt; &amp;source, <span class="keyword">const</span> <span class="keyword">char</span> *mime)</span></span>;</span><br><span class="line">    <span class="comment">// onTransact实现，直接调用BnMediaExtractorService</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">status_t</span>    <span class="title">onTransact</span><span class="params">(<span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">uint32_t</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Mutex               mLock;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在<code>IMediaExtractorService.h</code>中定义了两个接口，一个是抽象接口<code>IMediaExtractorService</code>，其中描述了<code>makeExtractor</code>这个行为；另一个则是用于实现Service端的<code>BnMediaExtractorService</code>。</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/include/media/IMediaExtractorService.h">IMediaExtractorService.h</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IMediaExtractorService</span>:</span> <span class="keyword">public</span> IInterface</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    DECLARE_META_INTERFACE(MediaExtractorService);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数为一个IDataSource和Mime-Type</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> sp&lt;IMediaExtractor&gt; <span class="title">makeExtractor</span><span class="params">(<span class="keyword">const</span> sp&lt;IDataSource&gt; &amp;source, <span class="keyword">const</span> <span class="keyword">char</span> *mime)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BnMediaExtractorService</span>:</span> <span class="keyword">public</span> BnInterface&lt;IMediaExtractorService&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">status_t</span>    <span class="title">onTransact</span><span class="params">(<span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">uint32_t</span> flags = <span class="number">0</span>)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>MediaExtractorService</code>是<code>BnMediaExtractorService</code>的子类，实现了<code>IMediaExtractorService</code>接口中定义的<code>makeExtractor</code>方法，且会在内部将发给自己的请求转发给<code>BnMediaExtractorService</code>。</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/services/mediaextractor/MediaExtractorService.h">MediaExtractorService.h</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;IMediaExtractor&gt; <span class="title">MediaExtractorService::makeExtractor</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;IDataSource&gt; &amp;remoteSource, <span class="keyword">const</span> <span class="keyword">char</span> *mime)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Remote发来的IDataSource转换为可用的DataSource</span></span><br><span class="line">    sp&lt;DataSource&gt; localSource = DataSource::CreateFromIDataSource(remoteSource);</span><br><span class="line">    <span class="comment">// 调用MediaExtractor的CreateFromService方法创建IMediaExtractor</span></span><br><span class="line">    sp&lt;IMediaExtractor&gt; ret = MediaExtractor::CreateFromService(localSource, mime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//（忽略了一些Check）</span></span><br><span class="line">    <span class="comment">// 如果创建成功，就将这个MediaExtractor注册到使用的Extractor中</span></span><br><span class="line">    <span class="comment">// MediaExtractorService的dump方法会调用dumpExtractors</span></span><br><span class="line">    <span class="comment">// 将最近使用的MediaExtractor信息dump到指定的fd</span></span><br><span class="line">    <span class="comment">// 推测是Debug用途</span></span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        registerMediaExtractor(ret, localSource, mime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">MediaExtractorService::onTransact</span><span class="params">(<span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 调用父类Binder服务端的BnMediaExtractorService处理</span></span><br><span class="line">    <span class="keyword">return</span> BnMediaExtractorService::onTransact(code, data, reply, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>BnMediaExtractorService</code>的实现在<code>IMediaExtractorService.cpp</code>中：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/media/libmedia/IMediaExtractorService.cpp">IMediaExtractorService.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// （略去了一些Check过程）</span></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">BnMediaExtractorService::onTransact</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="comment">// 接收MAKE_EXTRACTOR指令</span></span><br><span class="line">        <span class="keyword">case</span> MAKE_EXTRACTOR: &#123;</span><br><span class="line">            CHECK_INTERFACE(IMediaExtractorService, data, reply);</span><br><span class="line">            <span class="comment">// 读取第一个参数：IDataSource</span></span><br><span class="line">            sp&lt;IBinder&gt; b;</span><br><span class="line">            <span class="keyword">status_t</span> ret = data.readStrongBinder(&amp;b);</span><br><span class="line">            <span class="comment">// 将IBinder对象Cast为IDataSource</span></span><br><span class="line">            sp&lt;IDataSource&gt; source = interface_cast&lt;IDataSource&gt;(b);</span><br><span class="line">            <span class="comment">// 读取第二个参数：Mime-Type</span></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *mime = data.readCString();</span><br><span class="line">            <span class="comment">// 根据这两个参数，调用makeExtractor方法。</span></span><br><span class="line">            <span class="comment">// 最终调用的是在MediaExtractorService的makeExtractor方法</span></span><br><span class="line">            sp&lt;IMediaExtractor&gt; ex = makeExtractor(source, mime);</span><br><span class="line">            <span class="comment">// 将创建的IMediaExtractor通过reply参数返回</span></span><br><span class="line">            reply-&gt;writeStrongBinder(IInterface::asBinder(ex));</span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> BBinder::onTransact(code, data, reply, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DataSource创建"><a href="#DataSource创建" class="headerlink" title="DataSource创建"></a>DataSource创建</h2><p>首先来看如何从<code>IDataSource</code>创建对应的<code>DataSource</code>。</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/media/libstagefright/DataSource.cpp">DataSource.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;DataSource&gt; <span class="title">DataSource::CreateFromIDataSource</span><span class="params">(<span class="keyword">const</span> sp&lt;IDataSource&gt; &amp;source)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 第一步：创建一个CallbackDataSource包裹原本的IDataSource</span></span><br><span class="line">    <span class="comment">// 第二步：再创建一个外层的TinyCacheSource包裹这个CallbackDataSource</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TinyCacheSource(<span class="keyword">new</span> CallbackDataSource(source));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CallbackDataSource</code>实际上是对Remote<code>IDataSource</code>包裹的一个Wrapper。</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/media/libstagefright/CallbackDataSource.cpp">CallbackDataSource.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 举例：readAt方法的wrapper</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">CallbackDataSource::readAt</span><span class="params">(<span class="keyword">off64_t</span> offset, <span class="keyword">void</span>* data, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// mMemory成员来自IDataSource的getIMemory</span></span><br><span class="line">    <span class="comment">// 作为数据读取过程的Buffer</span></span><br><span class="line">    <span class="keyword">if</span> (mMemory == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// IDataSource can only read up to mMemory-&gt;size() bytes at a time, but this</span></span><br><span class="line">    <span class="comment">// method should be able to read any number of bytes, so read in a loop.</span></span><br><span class="line">    <span class="comment">// IDataSource内部的缓冲区大小固定（即mMemory-&gt;size()）</span></span><br><span class="line">    <span class="comment">// 因此下面这段代码循环利用mMemory实现任意大小的读取</span></span><br><span class="line">    <span class="keyword">size_t</span> totalNumRead = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> numLeft = size;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> bufferSize = mMemory-&gt;size();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (numLeft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果读取的部分比缓冲区大，则只读取bufferSize长度</span></span><br><span class="line">        <span class="keyword">size_t</span> numToRead = <span class="built_in">std</span>::min(numLeft, bufferSize);</span><br><span class="line">        <span class="keyword">ssize_t</span> numRead =</span><br><span class="line">            mIDataSource-&gt;readAt(offset + totalNumRead, numToRead);</span><br><span class="line">        <span class="comment">// A negative return value represents an error. Pass it on.</span></span><br><span class="line">        <span class="keyword">if</span> (numRead &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> numRead == ERROR_END_OF_STREAM &amp;&amp; totalNumRead &gt; <span class="number">0</span> ? totalNumRead : numRead;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// A zero return value signals EOS. Return the bytes read so far.</span></span><br><span class="line">        <span class="keyword">if</span> (numRead == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> totalNumRead;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 真实读取的长度比应该读取的长度更长，出错</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">size_t</span>)numRead &gt; numToRead) &#123;</span><br><span class="line">            <span class="keyword">return</span> ERROR_OUT_OF_RANGE;</span><br><span class="line">        &#125;</span><br><span class="line">        CHECK(numRead &gt;= <span class="number">0</span> &amp;&amp; (<span class="keyword">size_t</span>)numRead &lt;= bufferSize);</span><br><span class="line">        <span class="comment">// 从mMemory中将数据拷回data</span></span><br><span class="line">        <span class="built_in">memcpy</span>(((<span class="keyword">uint8_t</span>*)data) + totalNumRead, mMemory-&gt;pointer(), numRead);</span><br><span class="line">        numLeft -= numRead;</span><br><span class="line">        totalNumRead += numRead;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalNumRead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TinyCacheSource</code>实际上是对<code>CallbackSource</code>的进一步包装（可以应用于任意<code>DataSource</code>）。如果一次性读取的数据量小于某个常数<code>kCacheSize = 2048</code>，则读取固定的长度并在下次读取时直接从缓冲区里取。这样就避免了频繁操作<code>IDataSource</code>带来的Binder性能开销。定义在<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/media/libstagefright/include/CallbackDataSource.h">CallbackDataSource.h</a>中。</p>
<h2 id="MediaExtractor创建"><a href="#MediaExtractor创建" class="headerlink" title="MediaExtractor创建"></a>MediaExtractor创建</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// （省略了一些细节、Log以及DRM相关代码）</span></span><br><span class="line"><span class="function">sp&lt;MediaExtractor&gt; <span class="title">MediaExtractor::CreateFromService</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;DataSource&gt; &amp;source, <span class="keyword">const</span> <span class="keyword">char</span> *mime)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 注册一些Sniffer，这些Sniffer用于检测数据中包含的媒体类型</span></span><br><span class="line">    DataSource::RegisterDefaultSniffers();</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; meta;</span><br><span class="line">    String8 tmp;</span><br><span class="line">    <span class="keyword">if</span> (mime == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果Mime为空，尝试调用Sniffer测试媒体类型</span></span><br><span class="line">        <span class="keyword">float</span> confidence;</span><br><span class="line">        <span class="keyword">if</span> (!source-&gt;sniff(&amp;tmp, &amp;confidence, &amp;meta)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mime = tmp.<span class="built_in">string</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isDrm = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// 省略了DRM检测的过程。如果检测出DRM会将isDrm设为true</span></span><br><span class="line"></span><br><span class="line">    MediaExtractor *ret = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 根据Mime匹配选择创建的MediaExtractor类型</span></span><br><span class="line">    <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_CONTAINER_MPEG4)</span><br><span class="line">            || !strcasecmp(mime, <span class="string">&quot;audio/mp4&quot;</span>)) &#123;</span><br><span class="line">        ret = <span class="keyword">new</span> MPEG4Extractor(source);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// else if ...</span></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MediaExtractor实现分析"><a href="#MediaExtractor实现分析" class="headerlink" title="MediaExtractor实现分析"></a>MediaExtractor实现分析</h2><p>首先分析MediaExtractor实现的基础接口，<code>IMediaExtractor</code>, <code>BpMediaExtractor</code>和<code>BnMediaExtractor</code>。这是一个Binder匿名服务，即并没有在Binder Driver注册。</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/include/media/IMediaExtractor.h">IMediaExtractor.h</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IMediaExtractor</span> :</span> <span class="keyword">public</span> IInterface &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    DECLARE_META_INTERFACE(MediaExtractor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得Track数量</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">size_t</span> <span class="title">countTracks</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 获得一个给定的Track</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> sp&lt;IMediaSource&gt; <span class="title">getTrack</span><span class="params">(<span class="keyword">size_t</span> index)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 根据索引获得一个Track的MetaData</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> sp&lt;MetaData&gt; <span class="title">getTrackMetaData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">size_t</span> index, <span class="keyword">uint32_t</span> flags = <span class="number">0</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得这个媒体Container的Metadata</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> sp&lt;MetaData&gt; <span class="title">getMetaData</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 媒体能否支持某些行为</span></span><br><span class="line">    <span class="keyword">enum</span> Flags &#123;</span><br><span class="line">        CAN_SEEK_BACKWARD  = <span class="number">1</span>,  <span class="comment">// the &quot;seek 10secs back button&quot;</span></span><br><span class="line">        CAN_SEEK_FORWARD   = <span class="number">2</span>,  <span class="comment">// the &quot;seek 10secs forward button&quot;</span></span><br><span class="line">        CAN_PAUSE          = <span class="number">4</span>,</span><br><span class="line">        CAN_SEEK           = <span class="number">8</span>,  <span class="comment">// the &quot;seek bar&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// If subclasses do _not_ override this, the default is</span></span><br><span class="line">    <span class="comment">// CAN_SEEK_BACKWARD | CAN_SEEK_FORWARD | CAN_SEEK | CAN_PAUSE</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">uint32_t</span> <span class="title">flags</span><span class="params">()</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keyword">char</span> * <span class="title">name</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略了DRM相关方法</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>BpMediaExtractor</code>的实现很简单，作为一个Wrapper，实现了<code>IMediaExtractor</code>的接口，在这些接口中构造Binder数据包并发送该数据包给Service端。</p>
<p>实现举例：<a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/media/libmedia/IMediaExtractor.cpp">IMediaExtractor.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">size_t</span> <span class="title">BpMediaExtractor::countTracks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 准备数据，因为没有参数只需写入Token</span></span><br><span class="line">    Parcel data, reply;</span><br><span class="line">    data.writeInterfaceToken(BpMediaExtractor::getInterfaceDescriptor());</span><br><span class="line">    <span class="comment">// 发送Binder调用，返回结果</span></span><br><span class="line">    <span class="keyword">status_t</span> ret = remote()-&gt;transact(COUNTTRACKS, data, &amp;reply);</span><br><span class="line">    <span class="keyword">size_t</span> numTracks = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ret == NO_ERROR) &#123;</span><br><span class="line">        <span class="comment">// 如果正常返回，从reply中获取返回结果</span></span><br><span class="line">        numTracks = reply.readUint32();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> numTracks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://iondex.github.io/2020/10/04/android-binder/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="iondex">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Iondex's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/04/android-binder/" class="post-title-link" itemprop="url">Binder分析：基于Android-7.1.1_r6</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-10-04 15:40:16 / Modified: 20:02:34" itemprop="dateCreated datePublished" datetime="2020-10-04T15:40:16+08:00">2020-10-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/media/mediaserver/main_mediaserver.cpp">AndroidXRef - Android-7.1.1_r6</a></p>
<p>《深入理解Android卷1》（邓凡平）</p>
<h3 id="MediaServer入口"><a href="#MediaServer入口" class="headerlink" title="MediaServer入口"></a>MediaServer入口</h3><p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/av/media/mediaserver/main_mediaserver.cpp">main_mediaserver.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __unused, <span class="keyword">char</span> **argv __unused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 拦截并忽略所有SIGPIPE信号</span></span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用ProcessState::self()，确保ProcessState正确初始化</span></span><br><span class="line">    <span class="function">sp&lt;ProcessState&gt; <span class="title">proc</span><span class="params">(ProcessState::self())</span></span>;</span><br><span class="line">    <span class="comment">// 获得ServiceManager</span></span><br><span class="line">    <span class="function">sp&lt;IServiceManager&gt; <span class="title">sm</span><span class="params">(defaultServiceManager())</span></span>;</span><br><span class="line">    <span class="comment">// 初始化国际化库ICU</span></span><br><span class="line">    InitializeIcuOrDie();</span><br><span class="line">    <span class="comment">// 初始化MediaPlayerService和ResourceManagerService</span></span><br><span class="line">    MediaPlayerService::instantiate();</span><br><span class="line">    ResourceManagerService::instantiate();</span><br><span class="line">    <span class="comment">// 创建并启动线程池</span></span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ProcessState和IPCThreadState"><a href="#ProcessState和IPCThreadState" class="headerlink" title="ProcessState和IPCThreadState"></a>ProcessState和IPCThreadState</h3><p>进程唯一的ProcessState对象。</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/libs/binder/ProcessState.cpp">ProcessState.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单例模式，全局变量为NULL则主动初始化。</span></span><br><span class="line"><span class="function">sp&lt;ProcessState&gt; <span class="title">ProcessState::self</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Mutex::Autolock _l(gProcessMutex);</span><br><span class="line">    <span class="keyword">if</span> (gProcess != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> gProcess;</span><br><span class="line">    &#125;</span><br><span class="line">    gProcess = <span class="keyword">new</span> ProcessState;</span><br><span class="line">    <span class="keyword">return</span> gProcess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProcessState的创建过程，对每个进程只进行一次。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ProcessState::ProcessState()</span><br><span class="line">    : mDriverFD(open_driver())  <span class="comment">// 打开/dev/binder</span></span><br><span class="line">    , mVMStart(MAP_FAILED)   <span class="comment">// binder使用的mmap内存起始地址</span></span><br><span class="line">    <span class="comment">// ... 省略了一些（线程共用）计数器和其他内容</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDriverFD &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span></span><br><span class="line">        <span class="comment">// 为Binder分配一块内存接收传进和传出的transaction。</span></span><br><span class="line">        mVMStart = mmap(<span class="number">0</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PoolThread继承自Thread对象。实现中，<code>pthread</code>库在创建和启动进程时会调用Thread对象的<code>_threadLoop</code>函数，后者会调用子类实现（父类为纯虚函数）的<code>threadLoop</code>方法执行线程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PoolThread</span> :</span> <span class="keyword">public</span> Thread</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    PoolThread(<span class="keyword">bool</span> isMain)</span><br><span class="line">        : mIsMain(isMain)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">threadLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        IPCThreadState::self()-&gt;joinThreadPool(mIsMain);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> mIsMain;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>启动线程池。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProcessState::startThreadPool</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line">    <span class="comment">// 如果没有启动线程池，调用spawnPooledThread启动线程池</span></span><br><span class="line">    <span class="keyword">if</span> (!mThreadPoolStarted) &#123;</span><br><span class="line">        mThreadPoolStarted = <span class="literal">true</span>;</span><br><span class="line">        spawnPooledThread(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProcessState::spawnPooledThread</span><span class="params">(<span class="keyword">bool</span> isMain)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mThreadPoolStarted) &#123;</span><br><span class="line">        <span class="comment">// 创建一个名字，格式为 Binder:$&#123;PID&#125;_&#123;SeqID&#125;</span></span><br><span class="line">        String8 name = makeBinderThreadName();</span><br><span class="line">        <span class="comment">// 创建新的PoolThread并运行。</span></span><br><span class="line">        sp&lt;Thread&gt; t = <span class="keyword">new</span> PoolThread(isMain);</span><br><span class="line">        <span class="comment">// run方法会调用threadLoop()，后者会调用joinThreadPool将自己加入线程池。</span></span><br><span class="line">        t-&gt;run(name.<span class="built_in">string</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IPCThreadState，每个线程唯一（通过pthread保证）。负责通信。</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/libs/binder/IPCThreadState.cpp">IPCThreadState.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 线程主事件循环。获取并执行命令。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">IPCThreadState::joinThreadPool</span><span class="params">(<span class="keyword">bool</span> isMain)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mOut.writeInt32(isMain ? BC_ENTER_LOOPER : BC_REGISTER_LOOPER);</span><br><span class="line">    <span class="comment">// This thread may have been spawned by a thread that was in the background</span></span><br><span class="line">    <span class="comment">// scheduling group, so first we will make sure it is in the foreground</span></span><br><span class="line">    <span class="comment">// one to avoid performing an initial transaction in the background.</span></span><br><span class="line">    set_sched_policy(mMyThreadId, SP_FOREGROUND);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 处理积压的BBinder析构</span></span><br><span class="line">        processPendingDerefs();</span><br><span class="line">        <span class="comment">// now get the next command to be processed, waiting if necessary</span></span><br><span class="line">        result = getAndExecuteCommand();</span><br><span class="line">        <span class="comment">// 如果以上调用失败则会abort</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Let this thread exit the thread pool if it is no longer</span></span><br><span class="line">        <span class="comment">// needed and it is not the main process thread.</span></span><br><span class="line">        <span class="comment">// 超时没有命令获得，自动退出</span></span><br><span class="line">        <span class="keyword">if</span>(result == TIMED_OUT &amp;&amp; !isMain) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (result != -ECONNREFUSED &amp;&amp; result != -EBADF);</span><br><span class="line"></span><br><span class="line">    mOut.writeInt32(BC_EXIT_LOOPER);</span><br><span class="line">    talkWithDriver(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化过程</span></span><br><span class="line"><span class="function">IPCThreadState* <span class="title">IPCThreadState::self</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 有TLS说明已经创建过了，返回创建好的IPCThreadState，保证线程单例</span></span><br><span class="line">    <span class="keyword">if</span> (gHaveTLS) &#123;</span><br><span class="line">restart:</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">pthread_key_t</span> k = gTLS;</span><br><span class="line">        IPCThreadState* st = (IPCThreadState*)pthread_getspecific(k);</span><br><span class="line">        <span class="keyword">if</span> (st) <span class="keyword">return</span> st;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IPCThreadState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;gTLSMutex);</span><br><span class="line">    <span class="keyword">if</span> (!gHaveTLS) &#123;</span><br><span class="line">        <span class="comment">// 创建TLS</span></span><br><span class="line">        <span class="keyword">int</span> key_create_value = pthread_key_create(&amp;gTLS, threadDestructor);</span><br><span class="line">        <span class="keyword">if</span> (key_create_value != <span class="number">0</span>) &#123;</span><br><span class="line">            pthread_mutex_unlock(&amp;gTLSMutex);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        gHaveTLS = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;gTLSMutex);</span><br><span class="line">    <span class="comment">// 重试直到创建成功</span></span><br><span class="line">    <span class="keyword">goto</span> restart;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IPCThreadState向Binder Driver轮询命令，获取命令并执行。Binder事务的执行过程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">IPCThreadState::executeCommand</span><span class="params">(<span class="keyword">int32_t</span> cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BBinder* obj;</span><br><span class="line">    RefBase::weakref_type* refs;</span><br><span class="line">    <span class="keyword">status_t</span> result = NO_ERROR;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> ((<span class="keyword">uint32_t</span>)cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> BR_ERROR:</span><br><span class="line">        result = mIn.readInt32();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BR_OK:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指示释放一个对象，放入队列</span></span><br><span class="line">    <span class="keyword">case</span> BR_RELEASE:</span><br><span class="line">        refs = (RefBase::weakref_type*)mIn.readPointer();</span><br><span class="line">        obj = (BBinder*)mIn.readPointer();</span><br><span class="line">        mPendingStrongDerefs.push(obj);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 指示减少弱引用，将该refs放入队列等待</span></span><br><span class="line">    <span class="keyword">case</span> BR_DECREFS:</span><br><span class="line">        refs = (RefBase::weakref_type*)mIn.readPointer();</span><br><span class="line">        obj = (BBinder*)mIn.readPointer();</span><br><span class="line">        mPendingWeakDerefs.push(refs);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BR_ATTEMPT_ACQUIRE:</span><br><span class="line">        refs = (RefBase::weakref_type*)mIn.readPointer();</span><br><span class="line">        obj = (BBinder*)mIn.readPointer();</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">bool</span> success = refs-&gt;attemptIncStrong(mProcess.get());</span><br><span class="line">            ALOG_ASSERT(success &amp;&amp; refs-&gt;refBase() == obj,</span><br><span class="line">                       <span class="string">&quot;BR_ATTEMPT_ACQUIRE: object %p does not match cookie %p (expected %p)&quot;</span>,</span><br><span class="line">                       refs, obj, refs-&gt;refBase());</span><br><span class="line"></span><br><span class="line">            mOut.writeInt32(BC_ACQUIRE_RESULT);</span><br><span class="line">            mOut.writeInt32((<span class="keyword">int32_t</span>)success);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BR_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 读取transaction数据</span></span><br><span class="line">            binder_transaction_data tr;</span><br><span class="line">            result = mIn.read(&amp;tr, <span class="keyword">sizeof</span>(tr));</span><br><span class="line">            <span class="keyword">if</span> (result != NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            Parcel reply;</span><br><span class="line">            <span class="keyword">status_t</span> error;</span><br><span class="line">            <span class="comment">// 将目标转换为BBinder类型，并调用transact方法。后者会直接调用onTransact方法处理。</span></span><br><span class="line">            <span class="comment">// 这里不明白target.ptr与cookie的区别。</span></span><br><span class="line">            <span class="keyword">if</span> (tr.target.ptr) &#123;</span><br><span class="line">                <span class="comment">// We only have a weak reference on the target object, so we must first try to</span></span><br><span class="line">                <span class="comment">// safely acquire a strong reference before doing anything else with it.</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">reinterpret_cast</span>&lt;RefBase::weakref_type*&gt;(</span><br><span class="line">                        tr.target.ptr)-&gt;attemptIncStrong(<span class="keyword">this</span>)) &#123;</span><br><span class="line">                    error = <span class="keyword">reinterpret_cast</span>&lt;BBinder*&gt;(tr.cookie)-&gt;transact(tr.code, buffer,</span><br><span class="line">                            &amp;reply, tr.flags);</span><br><span class="line">                    <span class="keyword">reinterpret_cast</span>&lt;BBinder*&gt;(tr.cookie)-&gt;decStrong(<span class="keyword">this</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    error = UNKNOWN_TRANSACTION;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                error = the_context_object-&gt;transact(tr.code, buffer, &amp;reply, tr.flags);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 非单向的transaction需要发送回复</span></span><br><span class="line">            <span class="keyword">if</span> ((tr.flags &amp; TF_ONE_WAY) == <span class="number">0</span>) &#123;</span><br><span class="line">                LOG_ONEWAY(<span class="string">&quot;Sending reply to %d!&quot;</span>, mCallingPid);</span><br><span class="line">                <span class="keyword">if</span> (error &lt; NO_ERROR) reply.setError(error);</span><br><span class="line">                sendReply(reply, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LOG_ONEWAY(<span class="string">&quot;NOT sending reply to %d!&quot;</span>, mCallingPid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BR_NOOP:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BR_SPAWN_LOOPER:</span><br><span class="line">        mProcess-&gt;spawnPooledThread(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;*** BAD COMMAND %d received from Binder driver\n&quot;</span>, cmd);</span><br><span class="line">        result = UNKNOWN_ERROR;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">        mLastError = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获得ServiceManager的过程"><a href="#获得ServiceManager的过程" class="headerlink" title="获得ServiceManager的过程"></a>获得ServiceManager的过程</h3><p>ServiceManager是通过调用ProcessState的getContextObject方法得到的，该方法有两个重载，调用的是第一个重载：接收一个无用的参数，直接返回函数getStrongProxyForHandle的结果（即是一个wrapper）。</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/libs/binder/IServiceManager.cpp">IServiceManager.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;IServiceManager&gt; <span class="title">defaultServiceManager</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 单例模式</span></span><br><span class="line">    <span class="keyword">if</span> (gDefaultServiceManager != <span class="literal">NULL</span>) <span class="keyword">return</span> DefaultServiceManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加个代码块确保锁正确释放</span></span><br><span class="line">    &#123;</span><br><span class="line">        AutoMutex _l(gDefaultServiceManagerLock);</span><br><span class="line">        <span class="comment">// 轮询，从ProcessState那里通过getContextObject获得句柄</span></span><br><span class="line">        <span class="keyword">while</span> (gDefaultServiceManager == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            gDefaultServiceManager = interface_cast&lt;IServiceManager&gt;(</span><br><span class="line">                ProcessState::self()-&gt;getContextObject(<span class="literal">NULL</span>));</span><br><span class="line">            <span class="keyword">if</span> (gDefaultServiceManager == <span class="literal">NULL</span>)</span><br><span class="line">                sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> gDefaultServiceManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/libs/binder/ProcessState.cpp">ProcessState.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;IBinder&gt; <span class="title">ProcessState::getContextObject</span><span class="params">(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; <span class="comment">/*caller*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 直接调用getStrongProxyForHandle，参数handle为0</span></span><br><span class="line">    <span class="keyword">return</span> getStrongProxyForHandle(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// handle_entry结构体，包含一个IBinder对象和RefBase::weakref_type引用计数</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">handle_entry</span> &#123;</span></span><br><span class="line">    IBinder* binder;</span><br><span class="line">    RefBase::weakref_type* refs;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对指定的handle查找handle_entry</span></span><br><span class="line"><span class="function">ProcessState::handle_entry* <span class="title">ProcessState::lookupHandleLocked</span><span class="params">(<span class="keyword">int32_t</span> handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// mHandleToObject是一个（Android自定义的）Vector</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> N = mHandleToObject.size();</span><br><span class="line">    <span class="comment">// 如果handle数量小于索引（即直接调用会导致越界）</span></span><br><span class="line">    <span class="keyword">if</span> (N &lt;= (<span class="keyword">size_t</span>)handle) &#123;</span><br><span class="line">        handle_entry e;</span><br><span class="line">        e.binder = <span class="literal">NULL</span>;</span><br><span class="line">        e.refs = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// 创建一个全空的handle_entry并插入mHandleToObject</span></span><br><span class="line">        <span class="keyword">status_t</span> err = mHandleToObject.insertAt(e, N, handle+<span class="number">1</span>-N);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; NO_ERROR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;mHandleToObject.editItemAt(handle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;IBinder&gt; <span class="title">ProcessState::getStrongProxyForHandle</span><span class="params">(<span class="keyword">int32_t</span> handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;IBinder&gt; result;</span><br><span class="line"></span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line">    <span class="comment">// 查找这个handle，不存在则创建</span></span><br><span class="line">    handle_entry* e = lookupHandleLocked(handle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一般情况下会创建成功</span></span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// We need to create a new BpBinder if there isn&#x27;t currently one, OR we</span></span><br><span class="line">        <span class="comment">// are unable to acquire a weak reference on this current one.  See comment</span></span><br><span class="line">        <span class="comment">// in getWeakProxyForHandle() for more info about this.</span></span><br><span class="line">        IBinder* b = e-&gt;binder;</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">NULL</span> || !e-&gt;refs-&gt;attemptIncWeak(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (handle == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 对context manager（即service manager）的特殊处理。</span></span><br><span class="line">                <span class="comment">// 个人理解是，走到这个分支说明对应handle 0（service manager）的</span></span><br><span class="line">                <span class="comment">// handle_entry表项并未初始化</span></span><br><span class="line">                <span class="comment">// 而service manager可以在没有获取对应的BpBinder时就可以发送请求</span></span><br><span class="line">                <span class="comment">// 因此发送ping确保service manager仍然存活</span></span><br><span class="line">                Parcel data;</span><br><span class="line">                <span class="keyword">status_t</span> status = IPCThreadState::self()-&gt;transact(</span><br><span class="line">                        <span class="number">0</span>, IBinder::PING_TRANSACTION, data, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (status == DEAD_OBJECT)</span><br><span class="line">                   <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 新创建的handle_entry其binder成员为NULL，为其创建一个新BpBinder</span></span><br><span class="line">            b = <span class="keyword">new</span> BpBinder(handle);</span><br><span class="line">            e-&gt;binder = b;</span><br><span class="line">            <span class="comment">// e的refs成员设置为b自身的引用计数</span></span><br><span class="line">            <span class="keyword">if</span> (b) e-&gt;refs = b-&gt;getWeakRefs();</span><br><span class="line">            result = b;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 将result的指针内容指向b</span></span><br><span class="line">            result.force_set(b);</span><br><span class="line">            e-&gt;refs-&gt;decWeak(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总的来说，getStrongProxyForHandle首先查询handle是否已经存在（创建过），若已存在则直接返回；若不存在，对于<code>handle=0</code>会首先ping一下对应的service是否存在，然后根据这个handle新建一个BpBinder对象并返回。</p>
<p>总结：进程全局ServiceManager的创建过程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IServiceManager&gt; gDefaultServiceManager = </span><br><span class="line">    interface_cast&lt;IServiceManager&gt;(<span class="keyword">new</span> BpBinder(<span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<h3 id="Binder对象结构"><a href="#Binder对象结构" class="headerlink" title="Binder对象结构"></a>Binder对象结构</h3><p><img src="data:image/jpeg;base64,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TXPENvFJI3hpVjjUsSLtOg9sVFp3ifXdUsIb238NhoZl3ITdqDj8qANDwlqcmo6PhyrPbStblgSdwTgE57kVv1yOiRa0fEk93c6ULK1nhAk/0hZAXHQgLjHU5zk9Oa66gAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACuf8aFl8KXpUc/J3x/GK6Cuf8af8itd/WPI/7aLQBvr90Z64paReFA9qWgAooooAKKKKACiiigAooooAKKKKACiiigApD1FLQehoA57wkT9k1Dr/AMhG4/8AQzXQ1z3hUf6Dd8YB1C49f75roevNABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUtJS0AFFFFAAaSlNJQAUUUUAFFFFABRRRQAUUUUAVtQ/5B1z3/dN/I1leDR/xSGl4G39wvGf8a1NRbbpt0fSFz+hrO8IkHwpppXGPIXp9KANvHuaKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK5/wAZRiXwzcq2cF4vT/noo710FYPi8sPDsxUkESRf+jF9KANxPuinU1OVFOoAKKKKACiiigAooooAKKKKACiiigAooooAKRvun6UtGcUAc/4UINhdEdPt9x/6MNb4+6PpXP8AhE50675z/wATC4/9GGuhoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAClpKWgAooooADSUppKACiiigAooooAKKKKACiiigCnqv/ACCrs/8ATB//AEE1yPhfxholn4a062nuyk0cKhlEbHBx7Cuu1TnSbznH7h//AEE1neFIl/4RTS9yZJt0OSOvFAFdPH3hx+l83/fh/wDCkbx/4cXrev8A9+H/AMK6Pyk4+UflS+Wn9xefagDmm8e6GVBt3urljzsgtXdgPUjHSgeOdOIBFjq3Pb7DJ/hXS7EHRQO3SnYHpQBzA8daewyLDVv/AAAk/wAKVvHGnqufsOqn2Fi/FdN7dqKAOYTx1psgBWy1U57fYZB/Sg+OtNVAzWeqjPb7DIT+grpsCloA5mLxvp8xwtnqY92snX+YobxzpiHBtdT/AAsnP9K6aigDlT4+0wD/AI89V7YxYSc/pSv490tASbTVDj0sZD2z6V1OBRigDmF8daWybvs+pAc9bKQdPwqRPGunSDIttRA45azcf0ro6KAOaPjfTFGT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" alt="对象结构"></p>
<ul>
<li><p>IBinder是所有Binder通信相关对象的父类。实现了<code>queryLocalInterface</code>（默认返回NULL）、<code>getInterfaceDescriptor</code>（纯虚方法）、<code>transact</code>（纯虚方法）及其他接口。</p>
<ul>
<li>BpBinder是Client端用于和Service端交互的代理对象。</li>
<li>BBinder为对应的Service端代理对象。BpBinder和BBinder一一对应。</li>
</ul>
</li>
<li><p>IInterface：所有Interface的基类。定义了asBinder方法和onAsBinder纯虚方法。</p>
<ul>
<li>IXXX（如IServiceManager）：继承IInterface，通过<code>&#123;DECLARE,IMPLEMENT&#125;_META_INTERFACE</code>实现IInterface的接口。定义该服务提供的功能（方法）。</li>
</ul>
</li>
<li><p>BpRefBase是所有Bp类的基类。包含了mRemote成员和对应的remote()方法，该成员为BpBinder对象。</p>
<ul>
<li>BpInterface为BpRefBase的基类，只包含一个onAsBinder方法，该方法简单地调用父类的remote()方法。<ul>
<li>BpXXX（如BpServiceManager）继承IXXX和BpInterface类，是Client端使用ServiceManager的入口。实现了IXXX的方法，这些方法均是向remote发送transaction</li>
</ul>
</li>
</ul>
</li>
<li><p>BnXXX（如BnServiceManager）是Service端的实现，继承BBinder和IXXX。</p>
<ul>
<li>特殊情况：BnServiceManager并不存在，而对于其他服务BnXXX均存在。ServiceManager（Binder中叫Context Manager）是Binder本身的功能，其具体实现由Binder内部直接处理。</li>
</ul>
</li>
</ul>
<h4 id="通信相关实现"><a href="#通信相关实现" class="headerlink" title="通信相关实现"></a>通信相关实现</h4><h5 id="IBinder"><a href="#IBinder" class="headerlink" title="IBinder"></a>IBinder</h5><p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/include/binder/IBinder.h">IBinder.h</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IBinder</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> RefBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 查询这个IBinder对象是否实现了descriptor所描述的Interface</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> sp&lt;IInterface&gt;  <span class="title">queryLocalInterface</span><span class="params">(<span class="keyword">const</span> String16&amp; descriptor)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取这个IBinder对象对应的Interface名字</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> String16&amp; <span class="title">getInterfaceDescriptor</span><span class="params">()</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">status_t</span>        <span class="title">transact</span><span class="params">(   <span class="keyword">uint32_t</span> code,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">const</span> Parcel&amp; data,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Parcel* reply,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">uint32_t</span> flags = <span class="number">0</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/libs/binder/Binder.cpp">Binder.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IBinder基类，默认实现是直接返回NULL。BpBinder和BBinder均未override此方法。</span></span><br><span class="line"><span class="function">sp&lt;IInterface&gt;  <span class="title">IBinder::queryLocalInterface</span><span class="params">(<span class="keyword">const</span> String16&amp; <span class="comment">/*descriptor*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="BpBinder"><a href="#BpBinder" class="headerlink" title="BpBinder"></a>BpBinder</h5><p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/libs/binder/BpBinder.cpp">BpBinder.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BpBinder发送transact的方法，直接调用IPCThreadState单例的transact方法</span></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">BpBinder::transact</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Once a binder has died, it will never come back to life.</span></span><br><span class="line">    <span class="keyword">if</span> (mAlive) &#123;</span><br><span class="line">        <span class="keyword">status_t</span> status = IPCThreadState::self()-&gt;transact(</span><br><span class="line">            mHandle, code, data, reply, flags);</span><br><span class="line">        <span class="comment">// 如果transact返回DEAD_OBJECT，表明此BpBinder对应的Service不存在</span></span><br><span class="line">        <span class="keyword">if</span> (status == DEAD_OBJECT) mAlive = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> String16&amp; <span class="title">BpBinder::getInterfaceDescriptor</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 如果没有Cache，通过Binder查询访问</span></span><br><span class="line">    <span class="keyword">if</span> (isDescriptorCached() == <span class="literal">false</span>) &#123;</span><br><span class="line">        Parcel send, reply;</span><br><span class="line">        <span class="comment">// do the IPC without a lock held.</span></span><br><span class="line">        <span class="keyword">status_t</span> err = <span class="keyword">const_cast</span>&lt;BpBinder*&gt;(<span class="keyword">this</span>)-&gt;transact(</span><br><span class="line">                INTERFACE_TRANSACTION, send, &amp;reply);</span><br><span class="line">        <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">            <span class="function">String16 <span class="title">res</span><span class="params">(reply.readString16())</span></span>;</span><br><span class="line">            Mutex::Autolock _l(mLock);</span><br><span class="line">            <span class="comment">// mDescriptorCache could have been assigned while the lock was</span></span><br><span class="line">            <span class="comment">// released.</span></span><br><span class="line">            <span class="keyword">if</span> (mDescriptorCache.size() == <span class="number">0</span>)</span><br><span class="line">                mDescriptorCache = res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mDescriptorCache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="BBinder"><a href="#BBinder" class="headerlink" title="BBinder"></a>BBinder</h5><p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/include/binder/Binder.h">Binder.h</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BBinder</span> :</span> <span class="keyword">public</span> IBinder</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> String16&amp; <span class="title">getInterfaceDescriptor</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">status_t</span>    <span class="title">onTransact</span><span class="params">( <span class="keyword">uint32_t</span> code,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">const</span> Parcel&amp; data,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    Parcel* reply,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">uint32_t</span> flags = <span class="number">0</span>)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 虽然实现了这个方法，但子类应该override掉这个方法来提供descriptor</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> String16&amp; <span class="title">BBinder::getInterfaceDescriptor</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> String16 sEmptyDescriptor;</span><br><span class="line">    <span class="keyword">return</span> sEmptyDescriptor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// transact方法。除了ping之外，将所有命令交给onTransact方法</span></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">BBinder::transact</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    data.setDataPosition(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = NO_ERROR;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> PING_TRANSACTION:</span><br><span class="line">            reply-&gt;writeInt32(pingBinder());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            err = onTransact(code, data, reply, flags);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果有reply的话，确保数据位置</span></span><br><span class="line">    <span class="keyword">if</span> (reply != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        reply-&gt;setDataPosition(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一般来说子类实现onTransact时会fallback到这个父类方法</span></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">BBinder::onTransact</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, <span class="keyword">uint32_t</span> <span class="comment">/*flags*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="comment">// 回应查询Interface名字（descriptor）的请求</span></span><br><span class="line">        <span class="keyword">case</span> INTERFACE_TRANSACTION:</span><br><span class="line">            reply-&gt;writeString16(getInterfaceDescriptor());</span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...省略了其他命令</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> UNKNOWN_TRANSACTION;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="interface-cast和asInterface"><a href="#interface-cast和asInterface" class="headerlink" title="interface_cast和asInterface"></a><code>interface_cast</code>和<code>asInterface</code></h4><p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/include/binder/IInterface.h">IInterface.h</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> sp&lt;INTERFACE&gt; <span class="title">interface_cast</span><span class="params">(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 模板函数，调用INTERFACE本身的asInterface方法</span></span><br><span class="line">    <span class="keyword">return</span> INTERFACE::asInterface(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于实现Interface的通用宏（在类定义之外使用）</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_META_INTERFACE(INTERFACE, NAME)                       \</span></span><br><span class="line">    <span class="comment">// 描述符和获取描述符的方法</span></span><br><span class="line">    <span class="keyword">const</span> android::String16 I##INTERFACE::descriptor(NAME);             \</span><br><span class="line">    <span class="keyword">const</span> android::String16&amp;                                            \</span><br><span class="line">            I##INTERFACE::getInterfaceDescriptor() <span class="keyword">const</span> &#123;              \</span><br><span class="line">        <span class="keyword">return</span> I##INTERFACE::descriptor;                                \</span><br><span class="line">    &#125;                                                                   \</span><br><span class="line">    <span class="comment">// asInterface实现</span></span><br><span class="line">    android::sp&lt;I##INTERFACE&gt; I##INTERFACE::asInterface(                \</span><br><span class="line">            <span class="keyword">const</span> android::sp&lt;android::IBinder&gt;&amp; obj)                   \</span><br><span class="line">    &#123;                                                                   \</span><br><span class="line">        android::sp&lt;I##INTERFACE&gt; intr;                                 \</span><br><span class="line">        <span class="comment">// 如果传进来的BpBinder不为NULL</span></span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;                                              \</span><br><span class="line">            <span class="comment">// 通过obj本身的queryLocalInterface方法查询</span></span><br><span class="line">            <span class="comment">// 默认的实现（IBinder）如下，直接返回NULL</span></span><br><span class="line">            intr = <span class="keyword">static_cast</span>&lt;I##INTERFACE*&gt;(                          \</span><br><span class="line">                obj-&gt;queryLocalInterface(                               \</span><br><span class="line">                        I##INTERFACE::descriptor).get());               \</span><br><span class="line">            <span class="comment">// 如果未查询到，就创建一个BpXXX对象</span></span><br><span class="line">            <span class="keyword">if</span> (intr == <span class="literal">NULL</span>) &#123;                                         \</span><br><span class="line">                intr = <span class="keyword">new</span> Bp##INTERFACE(obj);                          \</span><br><span class="line">            &#125;                                                           \</span><br><span class="line">        &#125;                                                               \</span><br><span class="line">        <span class="keyword">return</span> intr;                                                    \</span><br><span class="line">    &#125;                                                                   \</span><br><span class="line">    I##INTERFACE::I##INTERFACE() &#123; &#125;                                    \</span><br><span class="line">    I##INTERFACE::~I##INTERFACE() &#123; &#125;                                   \</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</span><br><span class="line"><span class="keyword">inline</span> sp&lt;IInterface&gt; BnInterface&lt;INTERFACE&gt;::queryLocalInterface(</span><br><span class="line">        <span class="keyword">const</span> String16&amp; _descriptor)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如果传入的descriptor参数等于自己的descriptor，就返回自己</span></span><br><span class="line">    <span class="keyword">if</span> (_descriptor == INTERFACE::descriptor) <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 否则就返回空</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：进程全局ServiceManager创建的过程简化为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IServiceManager&gt; gDefaultServiceManager = </span><br><span class="line">    IServiceManager::asInterface(<span class="keyword">new</span> BpBinder(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// 进一步简化为</span></span><br><span class="line">sp&lt;IServiceManager&gt; gDefaultServiceManager = <span class="keyword">new</span> BpServiceManager(<span class="keyword">new</span> BpBinder(<span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<h4 id="Service端实现类"><a href="#Service端实现类" class="headerlink" title="Service端实现类"></a>Service端实现类</h4><p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/include/binder/Binder.h">Binder.h</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BpRefBase</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> RefBase</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 省略了引用计数相关的内容</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// 构造函数时，会增加mRemote的引用计数</span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span>  IBinder*        <span class="title">remote</span><span class="params">()</span>                </span>&#123; <span class="keyword">return</span> mRemote; &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    IBinder* <span class="keyword">const</span>          mRemote;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/include/binder/IInterface.h">IInterface.h</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模板类，继承了对应的Interface接口及BpRefBase</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BpInterface</span> :</span> <span class="keyword">public</span> INTERFACE, <span class="keyword">public</span> BpRefBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">                                BpInterface(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; remote);</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IBinder*            <span class="title">onAsBinder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造函数只是简单地调用了父类构造函数，将remote赋给mRemote</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</span><br><span class="line"><span class="keyword">inline</span> BpInterface&lt;INTERFACE&gt;::BpInterface(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; remote)</span><br><span class="line">    : BpRefBase(remote) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在调用onAsBinder时，返回mRemote</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</span><br><span class="line"><span class="keyword">inline</span> IBinder* BpInterface&lt;INTERFACE&gt;::onAsBinder()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> remote();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://androidxref.com/7.1.1_r6/xref/frameworks/native/libs/binder/IServiceManager.cpp">IServiceManager.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BpServiceManager</span> :</span> <span class="keyword">public</span> BpInterface&lt;IServiceManager&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// impl实际传入时为 new BpBinder(0)</span></span><br><span class="line">    BpServiceManager(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; impl)</span><br><span class="line">        : BpInterface&lt;IServiceManager&gt;(impl) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 例子：向service发送添加service的请求</span></span><br><span class="line">    <span class="comment">// 实际上是通过remote-&gt;transact()向service发送请求</span></span><br><span class="line">    <span class="comment">// 其他的功能实现方式类似</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">status_t</span> <span class="title">addService</span><span class="params">(<span class="keyword">const</span> String16&amp; name, <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; service,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">bool</span> allowIsolated)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Parcel data, reply;</span><br><span class="line">        data.writeInterfaceToken(IServiceManager::getInterfaceDescriptor());</span><br><span class="line">        data.writeString16(name);</span><br><span class="line">        data.writeStrongBinder(service);</span><br><span class="line">        data.writeInt32(allowIsolated ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">status_t</span> err = remote()-&gt;transact(ADD_SERVICE_TRANSACTION, data, &amp;reply);</span><br><span class="line">        <span class="keyword">return</span> err == NO_ERROR ? reply.readExceptionCode() : err;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ServiceManager的名字（descriptor）为 android.os.IServiceManager</span></span><br><span class="line">IMPLEMENT_META_INTERFACE(ServiceManager, <span class="string">&quot;android.os.IServiceManager&quot;</span>);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://iondex.github.io/2020/08/20/clang-standalone-tool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="iondex">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Iondex's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/20/clang-standalone-tool/" class="post-title-link" itemprop="url">编写Clang独立命令行工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-20 11:58:08" itemprop="dateCreated datePublished" datetime="2020-08-20T11:58:08+08:00">2020-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-04 15:33:23" itemprop="dateModified" datetime="2020-10-04T15:33:23+08:00">2020-10-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/banach-space/clang-tutor">Clang-Tutor</a><br><a target="_blank" rel="noopener" href="https://s3.amazonaws.com/connect.linaro.org/yvr18/presentations/yvr18-223.pdf">Slide</a><br><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/LibTooling.html">LibTooling</a></p>
</blockquote>
<p>LibTooling是LLVM提供的，用于编写基于Clang的独立命令行工具（Standalone Commandline Tool）的工具库。</p>
<p>和LibClang（提供一个基于Index和Cursor的C API）相比，LibTooling基于C++且功能更为强大，但由于功能更接近于Clang的核心，API更加复杂且不稳定，很可能随着Clang版本的变化导致API变化。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://iondex.github.io/2020/08/18/unicorn-reading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="iondex">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Iondex's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/18/unicorn-reading/" class="post-title-link" itemprop="url">UNICORN阅读笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-18 16:36:50" itemprop="dateCreated datePublished" datetime="2020-08-18T16:36:50+08:00">2020-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-04 15:33:23" itemprop="dateModified" datetime="2020-10-04T15:33:23+08:00">2020-10-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>APT的特征：</p>
<ul>
<li>APT攻击是长期行为（与传统攻击最大的区别）</li>
<li>经常利用0day漏洞</li>
</ul>
<p>传统解决方案：</p>
<ul>
<li>基于Malware Signature的方式无法发现利用0day漏洞的攻击【Before we knew it: an empirical study of zero-day attacks in the real world】</li>
<li>基于异常行为（Anomaly）检测的方法<ul>
<li>无法发现长期的行为模式</li>
<li>只是分析事件和syscall的小片段，更容易被攻击者规避</li>
</ul>
</li>
<li>长期行为建模【Long-span program behavior modeling and attack detection】，只局限于分析事件共同发生这种现象，避免过度使用计算和内存资源</li>
</ul>
<p>新的基于Provenance的APT检测：</p>
<ul>
<li>把整个系统的运行信息构造为一个有向无环图（DAG），描述系统的信息流动<ul>
<li>构造：<ul>
<li>subject，一般为进程；object，一般为各种OS对象（除了进程之外）</li>
<li>用事件event作为边来连接subject和object</li>
</ul>
</li>
<li>优势：<ul>
<li>即使两个相关的event间隔时间很长，图也能保留这种相关信息，提供APT追踪的更丰富的上下文</li>
<li>这种上下文信息可以更好地区分benign和malicious事件</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>现有工作的缺陷（静态代表FRAP，动态代表StreamSpot）：</p>
<ol>
<li>静态模型无法捕捉和获取系统的长期行为</li>
<li>由于APT攻击是长期行为，可能会逐渐污染动态模型（使模型将malicious的行为识别为benign行为）</li>
<li>需要将整个Provenance Graph放在主内存当中，因此不适合长期攻击的检测</li>
</ol>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>基于Syscall信息追踪的APT分析：</p>
<ul>
<li>早期研究只是单纯地对syscall日志进行分析，并尝试发现异常点（Outlier Point），或者通过一段syscall调用日志来分析和判断异常情况。这些都很难有效果，因为这些分析忽略了这一点或者一段syscall的历史信息，会导致很多FP。</li>
<li>后来有研究尝试从syscall信息重建Provenance Graph，但这种方法很难保证图的正确性：<ul>
<li>由于syscall记录本身可能是不正确、不完善和不可靠的</li>
<li>很多Hook系统调用的系统有因为并行执行导致的问题</li>
<li>很多内核级的记录系统有TOATTOU的bug，这个bug会导致记录的系统调用参数和实际传入内核的参数不同</li>
<li>由于很多内核线程并不使用系统调用，根据系统调用日志建图可能出现很多图不连通的问题</li>
</ul>
</li>
</ul>
<p>当前研究（FRAP，StreamSpot，HOLMES）的局限：</p>
<ol>
<li>预定义的边匹配规则过于敏感，且无法检测APT中常见的0day漏洞（针对HOLMES）</li>
<li>图分析只分析了局部特征，或是节点周围的小邻域，或者只是节点/边的属性，或者只是一部分子图</li>
<li>对系统行为的建模无法适应对APT的检测，静态模型无法描述长时间运行系统的动态特征（针对FRAP），而动态模型有被APT攻击污染的风险（针对StreamSpot）</li>
<li>Provenance Graph存储在内存当中，随着时间跨度增加、图的规模增大无法扩展</li>
</ol>
<h2 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h2><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><ol>
<li>输入一个带标签的流式图。这个图由CamFlow系统生成，只有一个图，包含整个系统的Provenance信息。</li>
<li>在线维护一个图的直方图。通过在线的迭代算法维护一个直方图，直方图中每个元素代表着某一类子图结构的数量，这个结构通过节点标签考虑了图的异质性，通过边权重考虑了时间序。同时，引入指数遗忘机制，缓慢减少直方图元素的分量，这样在保留信息流的同时可以适应系统状态变化。</li>
<li>周期性计算图的Sketch。采用HistoSketch算法，把变长且不断更新的直方图周期性地转换成长度相同的Sketch，这种Sketch可以用来计算相似度，并且本身也提供了指数遗忘和对Concept-Drift的支持。</li>
<li>构造正常运行时系统行为的模型。通过定期生成Sketch形成描述正常行为的Cluster，同时并不修改这些模型保证攻击行为不会污染模型。</li>
</ol>
<h3 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h3><p>直方图生成核心是1维WL算法的变种：</p>
<ul>
<li>概括来说就是通过迭代和重标签，逐步概括每一个节点周围的节点的结构信息（准确来说，是以每个节点为根的生成子树），生成一个直方图。最初用来比较小规模图的结构相似性。</li>
<li>针对原算法的改进：<ul>
<li>引入边标签，并将边标签也考虑到新的Label的生成过程中（原算法只有节点有标签）。</li>
<li>引入边的时间戳，在原算法的Label排序过程中利用时间戳进行排序。</li>
</ul>
</li>
</ul>
<p>适应流式系统的优化：</p>
<ul>
<li>在流式设计中，只对新的节点和新节点邻域内的节点运行一遍算法，这样就显著减少了计算量。</li>
<li><strong>偏序性</strong>：SOTA的Provenance记录系统应该保持偏序性，也就是说对于每个节点，其入边都会比出边早一步到达。在CamFlow这种用节点的Version来区分节点的系统，更新操作只需要在边对应的目标节点中进行。</li>
</ul>
<p>遗忘机制：</p>
<p>UNICORN在直方图生成上就直接引入了遗忘机制，在直方图构建时就按照时间将历史数据乘以与时间相关的权重。</p>
<h3 id="Sketch"><a href="#Sketch" class="headerlink" title="Sketch"></a>Sketch</h3><p>从Histogram生成Sketch这一步比较简单，根据数据的Streaming（在线更新）和Histogram分量非固定的特点，采用<strong>HistoSketch</strong>方法将一个Histogram转换为定长的Sketch。</p>
<h3 id="模型构建和异常检测"><a href="#模型构建和异常检测" class="headerlink" title="模型构建和异常检测"></a>模型构建和异常检测</h3><p>Sketch生成后，采用K-medoids算法进行分组，分组情况用Silhouette参数进行调优，对每一个Sketch赋予最佳分组号。</p>
<p>（K-medoids算法是常见的K-means算法的变种，将每个Cluster的中心作为分组基准；Silhouette是基于相似性提出的分组评价依据，衡量每个分组内元素的平均相似度）</p>
<p>通过定期生成Sketch并进行归类，可以形成一个Instance上系统运行的状态转移序列，这个状态转移序列就成为系统行为的建模。在部署时进行同样的步骤，对于每个Sketch的归类，如果和当前/下一状态的分类不同，则判定为异常。</p>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p>涉及到Provenance信息采集的部分基于CamFlow：</p>
<ul>
<li>基于Linux Security Models（LSM）框架来确保高质量和可靠的信息流追踪和记录</li>
<li>LSM解决了常见Syscall记录系统的竞争条件问题，通过将记录点直接设置在内核中而不是系统调用界面</li>
</ul>
<p>涉及到的图处理基于GraphChi：</p>
<ul>
<li>GraphChi是基于磁盘而非内存的图处理系统，可以很快地在规模很大的图上进行运算</li>
<li>GraphChi在内部用平行滑窗（PSW）算法把图分成边数类似的Shard，在每一个Shard上进行并行计算以加快速度</li>
<li>GraphChi的IO模型和批量操作使得图可以存储在磁盘当中，且在计算时保持相当的性能</li>
</ul>
<h2 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h2><p>UNICORN评估角度：</p>
<ol>
<li>准确性</li>
<li>哪些设计上的考虑比较重要</li>
<li>指数遗忘的策略是否有效</li>
<li>系统长期运行建模的有效性对比</li>
<li>速度，是否满足实时性要求</li>
<li>内存、CPU使用</li>
</ol>
<blockquote>
<p>Testing guidelines: Benchmarking crimes: an emerging threat in systems security</p>
</blockquote>
<h3 id="和StreamSpot比较"><a href="#和StreamSpot比较" class="headerlink" title="和StreamSpot比较"></a>和StreamSpot比较</h3><p>StreamSpot数据集：</p>
<ul>
<li>6个情景，其中5个对应Benign情形，有1个情景中发生了攻击事件，主要对应浏览器浏览行为</li>
<li>通过自动化，每个情景重复100遍，对应100个Graph，用Linux下的SystemTap系统记录所有Syscall</li>
</ul>
<p>与StreamSpot的比较：</p>
<ul>
<li>主要参数是图算法中的迭代参数R。在UNICORN的实现中，R增大（从1到3）对应着FP案例减少，也对应着算法提取更大范围邻域的信息</li>
<li>注：文中并未提到具体训练/测试集选取等细节，StreamSpot文章中有相应的分析</li>
</ul>
<h3 id="DARPA-TC-数据集测试"><a href="#DARPA-TC-数据集测试" class="headerlink" title="DARPA TC 数据集测试"></a>DARPA TC 数据集测试</h3><ul>
<li>总共3次实验，分别有Benign情形和APT攻击情形</li>
<li>训练/测试集分割：每次实验数据中90%划分为训练数据，10%为测试数据</li>
<li>结果：正确率极高，在三次实验中正确率达到98%以上。但文中并未说明这个正确率计算的<strong>载体</strong>（即这个正确率是节点正确率还是攻击检测正确率）。</li>
</ul>
<h3 id="参数选取问题"><a href="#参数选取问题" class="headerlink" title="参数选取问题"></a>参数选取问题</h3><p>UNICORN有如下参数：</p>
<ul>
<li>跳数/邻居半径。过小则无法提取足够信息，过大则会包括噪音。测试中3为最好。</li>
<li>Sketch大小。过大虽然可以包含更多信息，但也会导致维度爆炸。2000为最佳。</li>
<li>Sketch生成周期（以边数为单位）。过大则无法准确记录状态变化。3000为最佳。</li>
</ul>
<h2 id="Discussion"><a href="#Discussion" class="headerlink" title="Discussion"></a>Discussion</h2><h3 id="Anomaly"><a href="#Anomaly" class="headerlink" title="Anomaly"></a>Anomaly</h3><p>问题（基于异常行为检测的方法存在的通病）：</p>
<ul>
<li>需要一段训练的时间，假设在这段时间内系统中只会有Benign行为，并且能够全面捕捉到。</li>
<li>在训练期内发生的行为概括了绝大部分Benign行为。因此如果发生了新的Benign行为，就会产生FP。</li>
<li>同样，由于需要对状态进行建模，当系统状态被人为大幅改变时就会出现问题（比如备份还原）。</li>
</ul>
<p>UNICORN的改进点：</p>
<ul>
<li>UNICORN的算法更高效，能够稳定、高效、连续地对大规模系统进行建模。</li>
<li>UNICORN的图算法捕捉了范围更大的子图结构，因此能够总结更多的局部图信息，也就更难进行欺骗性攻击（mimicry attack）。</li>
<li>UNICORN的CWS算法引入了随机性，并不保证能通过模仿正常节点的特征来进行欺骗性攻击。</li>
</ul>
<h3 id="False-Alarm"><a href="#False-Alarm" class="headerlink" title="False Alarm"></a>False Alarm</h3><p>问题：</p>
<ul>
<li>UNICORN本质上是静态模型，来避免攻击行为污染模型。（实际上UNICORN定时从Provenance Graph生成Sketch作为当前系统运行状态的Snapshot；而模型一旦建立就不再改变）</li>
<li>由于静态模型的局限性，当正常的系统行为模式改变时，就会产生很多FP。</li>
</ul>
<p>UNICORN的改进点：</p>
<ul>
<li>通过HistoSketch引入Concept Drift，用于捕捉系统在正常运行的过程中产生的特征变化，并且避免产生过多的FP。</li>
</ul>
<h3 id="图分析"><a href="#图分析" class="headerlink" title="图分析"></a>图分析</h3><p>问题：</p>
<ul>
<li>图算法实际上有很多参数（最重要的参数可能是邻域半径R），如何确定参数是一个重要的问题。</li>
</ul>
<p>UNICORN的Argument：</p>
<ul>
<li>使用OpenTuner进行参数自动优化，自动选择最优参数。</li>
<li>对所有的测试都使用了相同的参数，具有稳定性。</li>
</ul>
<h3 id="系统行为同质性"><a href="#系统行为同质性" class="headerlink" title="系统行为同质性"></a>系统行为同质性</h3><p>讨论：</p>
<ul>
<li>StreamSpot数据集是对近乎同质的行为进行重复建模（主要是网页浏览等行为）。</li>
<li>UNICORN在StreamSpot上效果更好，说明这种方法在行为预定义的Host上效果更好。</li>
<li>而在Workstation这种环境下，APT攻击检测就更加困难。</li>
</ul>
<h3 id="数据集和交叉验证"><a href="#数据集和交叉验证" class="headerlink" title="数据集和交叉验证"></a>数据集和交叉验证</h3><p>讨论：</p>
<ul>
<li>现有数据比较少，很多数据是过期数据，或者无法直接构成Provenance Graph，需要翻译。</li>
<li>现有IDS的研究很多未开源，且采用自己的数据集，这些数据集的产生也未详述。</li>
<li>这就导致系统之间的比较十分困难。</li>
</ul>
<h2 id="Related-Work"><a href="#Related-Work" class="headerlink" title="Related Work"></a>Related Work</h2><h3 id="Intrusion-Detection"><a href="#Intrusion-Detection" class="headerlink" title="Intrusion Detection"></a>Intrusion Detection</h3><ul>
<li>定长的Syscall序列来定位攻击，推广到可变长度的特征序列。但准确性较低，无法应付复杂情形。（37 -&gt; 29，127）</li>
<li>为Syscall添加状态来提供上下文信息，用有限状态机进行行为建模。（109，36，62，81）但这种方法复杂度高于多项式复杂度，可行性较差。</li>
<li>总结性文章：113，78（扩展26，68，91）</li>
</ul>
<h3 id="Provenance"><a href="#Provenance" class="headerlink" title="Provenance"></a>Provenance</h3><p>初步工作：</p>
<ul>
<li>BackTracker：通过分析Provenance Graph找到攻击入口点。</li>
<li>PriorTracker：通过为节点赋予优先级简化分析过程，并引入前向分析找出攻击路径。</li>
<li>HERCULE：用Community Detection算法找出包含攻击路径的Community。</li>
<li>Winnower：在Povenance Graph上进行语义推断，以减少Provenance数据导致的存储和网络需求。</li>
<li>NoDoze：在Provenance Graph上实现攻击分流（attack triage），鉴别可疑的路径。</li>
<li>CamQuery：基于CamFlow，提出了能够实时分析Provenance Graph的框架，也说明Provenance Graph在APT分析方面很有价值。</li>
</ul>
<p>进一步工作：</p>
<ul>
<li>SLEUTH和HOLMES，注重于利用provenance数据进行攻击溯源和重建。背景框架是【Identifying the provenance of correlated anomalies】，都需要先验知识。</li>
<li>Poirot同样也是依赖先验信息，通过匹配攻击入口点来追踪APT。一般是通过专业的报告来找到这些入口点。</li>
</ul>
<h2 id="参考文献分类"><a href="#参考文献分类" class="headerlink" title="参考文献分类"></a>参考文献分类</h2><blockquote>
<p>异常行为检测：</p>
<p>114: Automated response using system-call delay<br>130: A sharper sense of self: Probabilistic reasoning of program behaviors for anomaly detection with context sensitivity<br>36: Anomaly detection using call stack information<br>81: Detecting intrusions through system call sequence and argument analysis<br>92: Exploiting execution context for the detection of anomalous system calls<br>109: A fast automatonbased method for detecting anomalous program behaviors</p>
<p>APT+图分析：</p>
<p>15: Mining data provenance to detect advanced persistent threats<br>19: Aggregating unsupervised provenance anomaly detectors<br>83: Fast memory-efficient anomaly detection in streaming heterogeneous graphs<br>87: Holmes: Real-time apt detection through correlation of suspicious information flows<br>55: Nodoze: Combatting threat alert fatigue with automated provenance triage<br>53: Frappuccino: fault-detection through runtime analysis of provenance</p>
<p>Syscall相关的APT分析：</p>
<p>37: A sense of self for unix processes<br>134: A markov chain model of temporal behavior for anomaly detection<br>61: Consistency analysis of authorization hook placement in the linux security modules framework<br>123: A markov chain model of temporal behavior for anomaly detection<br>43: Traps and pitfalls: Practical problems in system call interposition based security tools</p>
<p>存在的问题讨论：</p>
<p>125: Exploiting concurrency vulnerabilities in system call wrappers<br>98: A practical mimicry attack against powerful system-call monitors</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://iondex.github.io/2020/08/16/android-related-papers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="iondex">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Iondex's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/16/android-related-papers/" class="post-title-link" itemprop="url">Android Fuzzing/程序分析 相关文献</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-16 15:26:33" itemprop="dateCreated datePublished" datetime="2020-08-16T15:26:33+08:00">2020-08-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-04 15:33:23" itemprop="dateModified" datetime="2020-10-04T15:33:23+08:00">2020-10-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="IntelliDroid-NDSS’16"><a href="#IntelliDroid-NDSS’16" class="headerlink" title="IntelliDroid (NDSS’16)"></a>IntelliDroid (NDSS’16)</h3><p>IntelliDroid: A Targeted Input Generator for the Dynamic Analysis of Android Malware</p>
<p>研究对象：以触发某个特定API为目的，为动态分析工具产生<strong>输入</strong>。</p>
<p>开源：否。</p>
<p>方法：</p>
<ol>
<li>静态分析阶段：<ol>
<li>对于一个指定的API，逆向分析从程序入口（某个Event Handler）到这个API的Call Path。可能有多个Call Path。</li>
<li>用类似符号执行的方法解出每个Path上的Constraint。</li>
<li>一个Call Path上可能有多个事件（Event Chains）。</li>
</ol>
</li>
<li>动态阶段：<ol>
<li>获取运行时和每个约束相关的具体值。</li>
<li>注入事件。</li>
</ol>
</li>
</ol>
<h3 id="HARVESTOR-NDSS’16"><a href="#HARVESTOR-NDSS’16" class="headerlink" title="HARVESTOR (NDSS’16)"></a>HARVESTOR (NDSS’16)</h3><p>Harvesting Runtime Values in Android Applications That Feature Anti-Analysis Techniques</p>
<p>目的：获得运行时指定的某个值，由于Obfuscation/加壳/加密等其他原因静态分析不出来。</p>
<p>开源：否。</p>
<p>方法：静态 Backward Slicing。</p>
<h3 id="CopperDroid-NDSS’15"><a href="#CopperDroid-NDSS’15" class="headerlink" title="CopperDroid (NDSS’15)"></a>CopperDroid (NDSS’15)</h3><p>CopperDroid: Automatic Reconstruction of Android Malware Behaviors</p>
<p>目的：理解/重建（Reconstruct） Malware 的行为。</p>
<p>开源：否。</p>
<p>方法：Syscall分析。</p>
<ol>
<li>采用插桩过的QEMU模拟器运行无修改的Android，对QEMU进行插桩记录系统调用（swi指令，CPU privilege-level transitions寄存器<code>cpsr</code>）。</li>
<li>运行另一个Android虚拟机和特殊APP作为Unmarshalling Oracle，用来解码<code>io_ctl</code>中Binder调用的Payload。</li>
<li>根据以上两步的结果，采用(Value-Based) Data Flow Analysis重建和分析Malware的行为。</li>
</ol>
<h3 id="DroidScope-NDSS’12"><a href="#DroidScope-NDSS’12" class="headerlink" title="DroidScope (NDSS’12)"></a>DroidScope (NDSS’12)</h3><p>DroidScope: Seamlessly Reconstructing the OS and Dalvik Semantic Views for Dynamic Android Malware Analysis</p>
<p>目的：通过多层次（Multi-level）行为监控和分析，探究 Malware 行为并辅助分析。</p>
<p>开源：<strong>是</strong>。</p>
<p>方法：多层次分析（旧文章，不支持新的ART）。</p>
<ol>
<li>OS层。<ol>
<li>Syscall：通过QEMU插桩，分析系统调用指令swi及其参数、返回值。</li>
<li>Process/Thread：通过监控<code>task_struct</code>记录进程/线程信息。</li>
<li>Memory Map：维护一个 Shadow <code>mm_struct</code> 结构，并插桩<code>sys_mmap2</code>更新进程的Memory Map信息。</li>
</ol>
</li>
<li>Dalvik层。<ol>
<li>Dalvik支持JIT。通过分析Dalvik的Memory Map找出JVM指令和经过JIT编译的Hotspot机器码（涉及Dalvik底层）。</li>
<li>同样通过分析Memory Map找到Dalvik虚拟机状态。</li>
<li>通过<code>objdump</code>、Dalvik的Memory Map找到Symbol。</li>
</ol>
</li>
</ol>
<h3 id="DroidUnpack-NDSS’18"><a href="#DroidUnpack-NDSS’18" class="headerlink" title="DroidUnpack (NDSS’18)"></a>DroidUnpack (NDSS’18)</h3><p>Things You May Not Know About Android (Un)Packers: A Systematic Study based on Whole-System Emulation</p>
<p>目的：寻找一个通用的脱壳方法。DroidScope的后置工作。</p>
<p>背景：ART环境通过<code>dex2oat</code>将<code>dex</code>文件转换为<code>oat</code>机器码。（<code>oat</code>本质上是一个ELF，但有特殊的段）</p>
<p>方法：通过底层行为监控找出相关行为。</p>
<ol>
<li>在DroidScope的基础上做改进，重建OS-Leve和ART-Level的语义。<ol>
<li>OS-Level：找出所有进程的命名和Module加载信息，以便定位所有的Native Function。</li>
<li>ART-Level：<ol>
<li>对<code>libcutils.so</code>中的<code>set_process_name</code>函数插桩，确定进程的具体名称。</li>
<li>寻找进程中加载的<code>libart.so</code>，对于经过AOT编译的方法，ART会调用<code>ArtMethod::Invoke()</code>进行调用。</li>
<li>反之，会采用<code>DoCall()</code>调用Interpret模式的方法。从这两个途径找到<code>ArtMethod</code>结构。</li>
<li>从<code>ArtMethod::declaring_class_</code>找到在OAT文件中保存的原始DexFile和编译后的<code>OatClass</code>。</li>
</ol>
</li>
<li>自此，所有Native和ART中动态加载的函数信息全部取出。</li>
</ol>
</li>
<li>代码行为分析。<ol>
<li>监控所有写操作，记录Dirty Memory Region。遍历运行时的所有Basic Block，如果有重叠，说明这个Method是Unpack而来。</li>
<li>对Self Modifying Code和MultiLayer Pack的相关分析。</li>
</ol>
</li>
</ol>
<h3 id="FIRMSCOPE-NDSS’20"><a href="#FIRMSCOPE-NDSS’20" class="headerlink" title="FIRMSCOPE (NDSS’20)"></a>FIRMSCOPE (NDSS’20)</h3><p>FIRMSCOPE: Automatic Uncovering of Privilege-Escalation Vulnerabilities in Pre-Installed Apps in Android Firmware</p>
<p>目的：检测Firmware中预安装系统APK的权限提升（Privilege Escalation）问题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://iondex.github.io/2020/08/16/build-aosp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="iondex">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Iondex's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/16/build-aosp/" class="post-title-link" itemprop="url">AOSP编译问题记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-16 13:09:00" itemprop="dateCreated datePublished" datetime="2020-08-16T13:09:00+08:00">2020-08-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-04 15:33:23" itemprop="dateModified" datetime="2020-10-04T15:33:23+08:00">2020-10-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="编译AOSP的准备工作"><a href="#编译AOSP的准备工作" class="headerlink" title="编译AOSP的准备工作"></a>编译AOSP的准备工作</h1><h2 id="安装Repo"><a href="#安装Repo" class="headerlink" title="安装Repo"></a>安装Repo</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/bin</span><br><span class="line">PATH=~/bin:<span class="variable">$PATH</span></span><br><span class="line">curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo &gt; ~/bin/repo</span><br><span class="line">chmod a+x ~/bin/repo</span><br></pre></td></tr></table></figure>

<p>修改<code>.bashrc</code>或<code>.zshrc</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> REPO_URL=<span class="string">&#x27;https://mirrors.tuna.tsinghua.edu.cn/git/git-repo&#x27;</span></span><br><span class="line"><span class="built_in">export</span> LC_ALL=C</span><br><span class="line"><span class="built_in">export</span> PATH=~/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<h2 id="安装Repo初始化包"><a href="#安装Repo初始化包" class="headerlink" title="安装Repo初始化包"></a>安装Repo初始化包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar <span class="comment"># 下载初始化包</span></span><br><span class="line">tar xf aosp-latest.tar</span><br><span class="line"><span class="built_in">cd</span> aosp</span><br><span class="line"><span class="comment"># Install Python</span></span><br><span class="line">sudo apt-get install -y python</span><br><span class="line">repo sync</span><br></pre></td></tr></table></figure>

<p>这样设置之后<code>repo</code>的工作目录就在<code>aosp</code>文件夹，下载数据量为80G，<code>sync</code>后数据量为134G。</p>
<h2 id="初始化编译目录"><a href="#初始化编译目录" class="headerlink" title="初始化编译目录"></a>初始化编译目录</h2><p>在**<code>aosp</code>目录内**新建一个文件夹，如<code>android-4.4.2_r1</code>，作为编译的输出目录。<br>初始化源码目录（<code>-b</code>后为目标版本）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init</span></span><br><span class="line">repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-4.4.2_r1</span><br><span class="line"><span class="comment"># sync</span></span><br><span class="line">repo sync</span><br></pre></td></tr></table></figure>

<p>注意：在<code>aosp</code>目录外执行<code>repo</code>则需要重新下载<code>repo</code>及其初始化组件。</p>
<h2 id="准备编译环境"><a href="#准备编译环境" class="headerlink" title="准备编译环境"></a>准备编译环境</h2><p>安装编译的依赖（摘自<a target="_blank" rel="noopener" href="https://source.android.com/setup/build/initializing">Link</a>）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip</span><br></pre></td></tr></table></figure>

<h2 id="安装旧版本Oracle-JDK"><a href="#安装旧版本Oracle-JDK" class="headerlink" title="安装旧版本Oracle JDK"></a>安装旧版本Oracle JDK</h2><p>对于AOSP来说，编译Android 5.0之前的版本需要<strong>Oracle JDK 6</strong>（OpenJDK会报错），安装方法如下：</p>
<p>从Java Archive Downloads <a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase-java-archive-javase6-downloads.html">Link</a> 下载JDK版本。</p>
<p>当前下载需要登陆，网上的一个共享账号（目前此账号已经失效）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">账号：2696671285@qq.com </span><br><span class="line">密码：Oracle123</span><br></pre></td></tr></table></figure>

<h2 id="修改旧版本Make的限制"><a href="#修改旧版本Make的限制" class="headerlink" title="修改旧版本Make的限制"></a>修改旧版本Make的限制</h2><p>修改<code>build/core/main.mk</code>，加入新版本：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Add make-4.1</span></span><br><span class="line"><span class="keyword">ifeq</span> (0,<span class="variable">$(<span class="built_in">shell</span> expr $$(echo <span class="variable">$(MAKE_VERSION)</span> | sed &quot;s/[^0-9\.].*//&quot;)</span> = 4.1))</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h2 id="编译Android-4-4-2"><a href="#编译Android-4-4-2" class="headerlink" title="编译Android 4.4.2"></a>编译Android 4.4.2</h2><p>开始编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">. build/envsetup.sh</span><br><span class="line">lunch full_mako-userdebug </span><br><span class="line">m -j42</span><br></pre></td></tr></table></figure>

<h3 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build&#x2F;core&#x2F;base_rules.mk:134: *** external&#x2F;zlib: MODULE.TARGET.SHARED_LIBRARIES.libz already defined by external&#x2F;arm-trusted-firmware&#x2F;lib&#x2F;zlib&#x2F;zlib.  Stop.</span><br></pre></td></tr></table></figure>

<p>解决方法：<code>external/arm-trusted-firmware/lib/zlib/zlib</code>是<code>external/zlib</code>的符号链接，这里并不清楚为何会导致此错误（猜测为<code>make</code>版本不正确导致无法正确检测符号链接）。删除<code>external/arm-trusted-firmware</code>即可继续编译。</p>
<h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make: *** No rule to make target &#39;hardware&#x2F;qcom&#x2F;sm8150&#x2F;Android.mk&#39;.  Stop.</span><br></pre></td></tr></table></figure>

<p>（同样错误可能会出现在<code>hardware/</code>路径下的其他文件夹，解决方法类似）</p>
<p>解决方法：将文件夹<code>hardware/qcom/sm8150/</code>内的<code>Android.mk</code>和<code>Android.bp</code>文件改名。</p>
<h3 id="问题3"><a href="#问题3" class="headerlink" title="问题3"></a>问题3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;scripts&#x2F;make_css_value_keywords.py&quot;, line 177, in &lt;module&gt;</span><br><span class="line">    in_generator.Maker(CSSValueKeywordsWriter).main(sys.argv)</span><br><span class="line">  File &quot;&#x2F;home&#x2F;yufeng&#x2F;aosp&#x2F;external&#x2F;chromium_org&#x2F;third_party&#x2F;WebKit&#x2F;Source&#x2F;core&#x2F;scripts&#x2F;in_generator.py&quot;, line 119, in main</span><br><span class="line">    writer.write_files(options.output_dir)</span><br><span class="line">  File &quot;&#x2F;home&#x2F;yufeng&#x2F;aosp&#x2F;external&#x2F;chromium_org&#x2F;third_party&#x2F;WebKit&#x2F;Source&#x2F;core&#x2F;scripts&#x2F;in_generator.py&quot;, line 77, in write_files</span><br><span class="line">    self._write_file(output_dir, generator(), file_name)</span><br><span class="line">  File &quot;scripts&#x2F;make_css_value_keywords.py&quot;, line 172, in generate_implementation</span><br><span class="line">    gperf &#x3D; subprocess.Popen(gperf_args, stdin&#x3D;subprocess.PIPE, stdout&#x3D;subprocess.PIPE)</span><br><span class="line">  File &quot;&#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;subprocess.py&quot;, line 394, in __init__</span><br><span class="line">    errread, errwrite)</span><br><span class="line">  File &quot;&#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;subprocess.py&quot;, line 1047, in _execute_child</span><br><span class="line">    raise child_exception</span><br><span class="line">OSError: [Errno 2] No such file or directory</span><br><span class="line">Gyp action: third_party_WebKit_Source_core_core_derived_sources_gyp_make_derived_sources_target_MathMLNames (out&#x2F;target&#x2F;product&#x2F;mako&#x2F;obj&#x2F;GYP&#x2F;shared_intermediates&#x2F;blink&#x2F;MathMLNames.cpp)</span><br><span class="line">external&#x2F;chromium_org&#x2F;third_party&#x2F;WebKit&#x2F;Source&#x2F;core&#x2F;make_derived_sources.target.linux-arm.mk:108: recipe for target &#39;out&#x2F;target&#x2F;product&#x2F;mako&#x2F;obj&#x2F;GYP&#x2F;shared_intermediates&#x2F;blink&#x2F;CSSValueKeywords.cpp&#39; failed</span><br><span class="line">make: *** [out&#x2F;target&#x2F;product&#x2F;mako&#x2F;obj&#x2F;GYP&#x2F;shared_intermediates&#x2F;blink&#x2F;CSSValueKeywords.cpp] Error 1</span><br></pre></td></tr></table></figure>

<p>解决方式：安装<code>gperf</code>，<code>sudo apt-get install -y gperf</code>。</p>
<h2 id="编译Android-6-0-1"><a href="#编译Android-6-0-1" class="headerlink" title="编译Android 6.0.1"></a>编译Android 6.0.1</h2><p>安装OpenJDK 7，下载链接：</p>
<p>安装完成之后用<code>update-alternatives</code>调换版本。</p>
<p>注意：此版本的Makefile与当前下载的OpenJDK 7并不兼容，需要手动修改Makefile。</p>
<p>开始编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">. build/envsetup.sh</span><br><span class="line">lunch aosp_bullhead-userdebug </span><br><span class="line">m -j42</span><br></pre></td></tr></table></figure>

<h2 id="问题1-1"><a href="#问题1-1" class="headerlink" title="问题1"></a>问题1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: unsupported reloc 43</span><br></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/36048358/building-android-from-sources-unsupported-reloc-43">https://stackoverflow.com/questions/36048358/building-android-from-sources-unsupported-reloc-43</a></p>
<p>此问题是由于提供的工具链<code>ld</code>版本不正确导致的，解决方式：</p>
<p><code>cp /usr/bin/ld.gold prebuilts/gcc/linux-x86/host/*/x86_64-linux/bin/ld</code></p>
<p>即将<code>repo</code>目录下<code>prebuilts/gcc/linux-x86/host</code>目录下所有的工具链内<code>ld</code>命令进行替换。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">iondex</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">iondex</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
